---
title: "2.4. QUIC的握手过程"
anchor: "2.4_The_QUIC_Handshake"
weight: 240
rank: "h2"
---

New QUIC connections are established using a handshake that is distinguishable on the wire (see Section 3.1 for details) and contains some information that can be passively observed.

新的QUIC连接是通过使用一套能够在通信线路上分辨出来的握手过程来建立的，其中包含着一些可以受到被动观测的信息。

To illustrate the information visible in the QUIC wire image during the handshake, we first show the general communication pattern visible in the UDP datagrams containing the QUIC handshake. Then, we examine each of the datagrams in detail.

为了说明在握手期间的QUIC通信线路图象中可观察到的信息，我们首先展示的是在包含QUIC握手的UDP数据报中可见的一般通信模式。
随后，我们再详细地检视每一个数据报。

The QUIC handshake can normally be recognized on the wire through four flights of datagrams labeled "Client Initial", "Server Initial", "Client Completion", and "Server Completion" as illustrated in Figure 1.

如[图1](#Figure_1_General_Communication_Pattern_Visible_in_the_QUIC_Handshake)所示，通常可以通过通信线路上的四程数据报来辨识QUIC的握手过程，它们分别被标记为“客户端初始”、“服务器初始”、“客户端完成”，和“服务器完成”。

A handshake starts with the client sending one or more datagrams containing Initial packets (detailed in Figure 2), which elicits the Server Initial response (detailed in Figure 3), which typically contains three types of packets: Initial packet(s) with the beginning of the server's side of the TLS handshake, Handshake packet(s) with the rest of the server's portion of the TLS handshake, and 1-RTT packet(s), if present.

握手过程以客户端发送一份或多份携带着初始数据包的数据报（详见[图2](#Figure_2_Example_Client_Initial_Datagram_Without_0_RTT)）的方式发起，这会引发标记为“服务器初始”的响应（详见[图3](#Figure_3_Coalesced_Server_Initial_Datagram_Pattern)），其中通常包含三种类型的数据包：带有服务器一侧的TLS握手过程起始部分的初始数据包（一个或多个）、包含着服务器一侧的TLS握手过程剩余部分的握手数据包（一个或多个），还有，如果存在的话，1-RTT数据包（一个或多个）。

{{< block_img
indx="Figure_1_General_Communication_Pattern_Visible_in_the_QUIC_Handshake"
title="图1：QUIC的握手过程中可见的一般通信模式"
src="/RFC9312_Chinese_Simplified/images/Figure_1_General_Communication_Pattern_Visible_in_the_QUIC_Handshake.svg" >}}

As shown here, the client can send 0-RTT data as soon as it has sent its ClientHello and the server can send 1-RTT data as soon as it has sent its ServerHello. The Client Completion flight contains at least one Handshake packet and could also include an Initial packet. During the handshake, QUIC packets in separate contexts can be coalesced (see Section 2.2) in order to reduce the number of UDP datagrams sent during the handshake.

如图所示，一旦客户端发送完`ClientHello`（客户端问候），它就能够发送0-RTT数据；一旦服务器发送完`ServerHello`（服务器问候），它就能够发送1-RTT数据。
“客户端完成”中包含着至少一个握手数据包，此外还可以包含一个初始数据包。
在握手期间，不同上下文中的QUIC数据包可以被合并（详见[第2.2章](#2.2_Coalesced_Packets)），从而将此握手期间发送的UDP数据报数量。

Handshake packets can arrive out-of-order without impacting the handshake as long as the reordering was not accompanied by extensive delays that trigger a spurious Probe Timeout (Section 6.2 of [QUIC-RECOVERY]). If QUIC packets get lost or reordered, packets belonging to the same flight might not be observed in close time succession, though the sequence of the flights will not change because one flight depends upon the peer's previous flight.

哪怕出现了数据包乱序的情况，只要数据包没有被过分延误以至于触发了探测包超时（详见《[QUIC恢复](../RFC9002_Chinese_Simplified)》的[第6.2章](../RFC9002_Chinese_Simplified/#6.2_Probe_Timeout)），乱序抵达的握手数据包就不会影响握手。
尽管因为任意一程数据包都依赖于对端发出的前一程数据包所以这几程数据包的顺序不会发生变化，但是如果某个QUIC数据包遭遇丢包或乱序，那么就不太可能在其邻近的时间段内观察到属于同一程的其他数据包。

Datagrams that contain an Initial packet (Client Initial, Server Initial, and some Client Completion) contain at least 1200 octets of UDP payload. This protects against amplification attacks and verifies that the network path meets the requirements for the minimum QUIC IP packet size; see Section 14 of [QUIC-TRANSPORT]. This is accomplished by either adding PADDING frames within the Initial packet, coalescing other packets with the Initial packet, or leaving unused payload in the UDP packet after the Initial packet. A network path needs to be able to forward packets of at least this size for QUIC to be used.

包含着初始数据包的数据报（“客户端初始”、“服务器初始”，以及部分“客户端完成”），其UDP载荷长度至少为1200字节。
这能够抵御放大攻击，并验证网络路径是否满足能够发送封装着QUIC的最小尺寸IP数据包的要求；详见《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第14章](../RFC9000_Chinese_Simplified/#14_Datagram_Size)。
这可以通过在初始数据包内部添加**填充帧**、将初始数据包与其他数据包合并，或在初始数据包后方的UDP载荷中放置未使用的内容的方式来做到。
所有支持QUIC的网络路径都应该有能力转发尺寸至少为该值的数据包。

The content of Initial packets is encrypted using Initial Secrets, which are derived from a per-version constant and the client's Destination Connection ID. That content is therefore observable by any on-path device that knows the per-version constant and is considered visible in this illustration. The content of QUIC Handshake packets is encrypted using keys established during the initial handshake exchange and is therefore not visible.

初始数据包中的内容是使用初始秘密值来加密的，该秘密值由特定于版本的常量与客户端的目标连接ID衍生而来。
因此该内容对路径上所有知道该特定于版本的常量的设备来说都是可观察的，因此在图示中被视为可见。
QUIC握手数据包的内容受到加密，因此被视作不可见，加密时使用的密钥是在初始握手通信时建立的。

Initial, Handshake, and 1-RTT packets belong to different cryptographic and transport contexts. The Client Completion (Figure 4) and the Server Completion (Figure 5) flights conclude the Initial and Handshake contexts by sending final acknowledgments and CRYPTO frames.

初始数据包、握手数据包和1-RTT数据包属于不同的加密和传输上下文。
“客户端完成”（详见[图4](#Figure_4_Coalesced_Client_Completion_Datagram_Pattern)）和“服务器完成”（详见[图5](#Figure_5_Coalesced_Server_Completion_Datagram_Pattern)）这两程通过发送最终确认和**加密帧**的方式终止了初始和握手上下文。

{{< block_img
indx="Figure_2_Example_Client_Initial_Datagram_Without_0_RTT"
title="图2：无0-RTT的“客户端初始”数据报样例"
src="/RFC9312_Chinese_Simplified/images/Figure_2_Example_Client_Initial_Datagram_Without_0_RTT.svg" >}}

A Client Initial packet exposes the Version, Source, and Destination Connection IDs without encryption. The payload of the Initial packet is protected using the Initial secret. The complete TLS ClientHello, including any TLS Server Name Indication (SNI) present, is sent in one or more CRYPTO frames across one or more QUIC Initial packets.

”客户端初始“数据报暴露了未经加密的版本、源连接ID和目标连接ID字段。
初始数据包的载荷受到初始秘密值的保护。
带有TLS服务器名称指示（SNI）的完整TLS `ClientHello`，是通过使用一个或多个**加密帧**，在一个或多个QUIC初始数据包中发送的。

{{< block_img
indx="Figure_3_Coalesced_Server_Initial_Datagram_Pattern"
title="图3：含有合并数据包的“服务器初始”数据报模式"
src="/RFC9312_Chinese_Simplified/images/Figure_3_Coalesced_Server_Initial_Datagram_Pattern.svg" >}}

The Server Initial datagram also exposes the version number and the Source and Destination Connection IDs in the clear; the payload of the Initial packet is protected using the Initial secret.

”服务器初始“数据报也暴露了明文的版本、源连接ID和目标连接ID字段；初始数据包的载荷受到初始秘密值的保护。

{{< block_img
indx="Figure_4_Coalesced_Client_Completion_Datagram_Pattern"
title="图4：含有合并数据包的“客户端完成”数据报模式"
src="/RFC9312_Chinese_Simplified/images/Figure_4_Coalesced_Client_Completion_Datagram_Pattern.svg" >}}

The Client Completion flight does not expose any additional information; however, as the Destination Connection ID is server-selected, it usually is not the same ID that is sent in the Client Initial. Client Completion flights contain 1-RTT packets that indicate the handshake has completed (see Section 3.2) on the client and for three-way handshake RTT estimation as in Section 3.8.

”客户端完成“这一程没有暴露任何额外信息；不过，由于目标连接ID是由服务器选择的，因此它通常与客户端在”客户端初始“中发送的ID不一致。
”客户端完成“这一程包含着一个表示客户端一侧的握手过程已完成的1-RTT数据包（详见[第3.2章](#3.2_Connection_Confirmation)），它被用于三向握手RTT预估，详见[第3.8章](#3.8_Round_Trip_Time_RTT_Measurement)。

{{< block_img
indx="Figure_5_Coalesced_Server_Completion_Datagram_Pattern"
title="图5：含有合并数据包的“服务器完成”数据报模式"
src="/RFC9312_Chinese_Simplified/images/Figure_5_Coalesced_Server_Completion_Datagram_Pattern.svg" >}}

Similar to Client Completion, Server Completion does not expose additional information; observing it serves only to determine that the handshake has completed.

与”客户端完成“类似，”服务器完成“没有暴露额外信息；对它的观察结果仅可用于判断握手是否已完成。

When the client uses 0-RTT data, the Client Initial flight can also include one or more 0-RTT packets as shown in Figure 6.

如[图6](#Figure_6_Coalesced_0_RTT_Client_Initial_Datagram)所示，当客户端使用0-RTT数据时，”客户端初始“这一程中还可以包含一个或多个0-RTT数据包。

{{< block_img
indx="Figure_6_Coalesced_0_RTT_Client_Initial_Datagram"
title="图6：含有合并数据包和0-RTT的“客户端初始”数据报"
src="/RFC9312_Chinese_Simplified/images/Figure_6_Coalesced_0_RTT_Client_Initial_Datagram.svg" >}}

When a 0-RTT packet is coalesced with an Initial packet, the datagram will be padded to 1200 bytes. Additional datagrams containing only 0-RTT packets with long headers can be sent after the client Initial packet, which contains more 0-RTT data. The amount of 0-RTT protected data that can be sent in the first flight is limited by the initial congestion window, typically to around 10 packets (see Section 7.2 of [QUIC-RECOVERY]).

当某0-RTT数据包与某初始数据包合并时，数据报将被填充至1200字节。
可以在发送完客户端初始数据包后发送仅包含长包头0-RTT数据包的额外数据报，在其中包含更多0-RTT数据。
可以在首程中发送的受0-RTT密钥保护的数据量受限于初始拥塞窗口，一般约为10个数据包的大小（详见《[QUIC恢复](../RFC9002_Chinese_Simplified)》的[第7.2章](../RFC9002_Chinese_Simplified/#7.2_Initial_and_Minimum_Congestion_Window)）。
