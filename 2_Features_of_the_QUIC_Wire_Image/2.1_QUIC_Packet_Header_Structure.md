---
title: "2.1. QUIC数据包头部结构"
anchor: "2.1_QUIC_Packet_Header_Structure"
weight: 210
rank: "h2"
---

QUIC的数据包要么使用长包头，要么使用短包头。
QUIC数据包头部的首个比特位是包头形式比特位，表示当前的头部类型。
该比特位的作用不会随QUIC版本变化而改变。

长包头暴露了更多信息。
它包含着一个版本号，以及用于将数据包与QUIC连接关联起来的源连接ID和目标连接ID。
这些字段在QUIC长包头中的位置及其定义即便在将来版本的QUIC中，也是一致的，不过将来版本的QUIC或许会在长包头中提供额外字段（详见《[QUIC不变量](../RFC8999_Chinese_Simplified)》）。

在QUIC版本1中，长包头被用于在连接建立期间传输**加密帧**握手数据、进行版本协商、重试，以及发送0-RTT数据。

在QUIC版本1中，短包头被用于连接建立完成后，并且仅暴露了可选的目标连接ID字段，以及初始的信号量字节，其中包括用于RTT测量的自旋比特位。

在所有版本的QUIC中，QUIC数据包头部都会暴露以下信息（由《[QUIC不变量](../RFC8999_Chinese_Simplified)》规定）：

版本号：

:   版本号出现在长包头中，标识着适用于该数据包的版本。
在版本协商期间（详见[第2.8章](#2.8_Version_Negotiation_and_Greasing)和《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第17.2.1章](../RFC9000_Chinese_Simplified/#17.2.1_Version_Negotiation_Packet)），版本字段适用特殊值（`0x00000000`），它将数据包标识为版本协商数据包。
QUIC版本1使用版本号`0x00000001`。
作为各种互联网实验、将来的标准，以及位转义（详见《[RFC7801](https://www.rfc-editor.org/info/rfc7801)》）的结果，运营商应该期望观察到具有其他版本号的数据包。
有一个IANA注册表专门管理着所有标准化QUIC版本的值其中也可能出现一些专有值（详见《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第22.2章](../RFC9000_Chinese_Simplified/#22.2_QUIC_Versions_Registry)）。
不过，在互联网中应该能随时见到其他版本的QUIC。

源和目标连接ID：

:   短包头和长包头中均存在目标连接ID，它是一个可变长度的字段。
如果目标连接ID并非零长度，那么就能利用它来辨识与QUIC数据包关联着的连接，从而满足负载均衡和NAT重绑定的需要；详见[第4.4章](#4.4_Server_Cooperation_with_Load_Balancers)和[第2.6章](#2.6_Connection_ID_and_Rebinding)。
长包头额外携带着源连接ID。
源连接ID仅在长包头上出现，表示的是另一终端在发送数据包时应该使用的目标连接ID值。
在长包头中，还会出现连接ID的长度字段。
在短包头中，没有表明目标连接ID的长度，因为可以从前序的长包头数据包中知道该值。

在QUIC版本1中，额外暴露了以下信息：

固定比特位：

:   在QUIC版本1中，首个字节的第二最高有效位被设置位`1`，除非该数据包是一个版本协商数据包，或使用了修改此比特位作用的扩展。
如果该比特位被设置为`1`，就能使得终端能够轻松地为它与其他用UDP封装的协议数据包解除多路复用。
尽管该比特位在版本1的规范中是固定值，但是终端仍可以使用修改此比特位的扩展（详见《[QUIC位转义](../RFC9287_Chinese_Simplified)》）。
因此，运营商无法将它用作可靠的QUIC标识符。

延迟自选比特位：

:   版本1的短包头中，首个字节的第三最高有效位。
自旋比特位由终端设置，以便用跟踪边缘转换的方式被动地观察终端间的RTT。
有关细节，详见[第3.8.2章](#3.8.2_Using_the_Spin_Bit_for_Passive_RTT_Measurement)。

头部类型：

:   长包头中，包头形式和固定比特位的后面跟着一个2比特位长的数据包类型字段。
头部类型与握手阶段对应；有关细节，详见《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第17.2章](../RFC9000_Chinese_Simplified/#17.2_Long_Header_Packets)。

长度：

:  长包头中，该QUIC数据包跟在长度字段后面的剩余部分的长度。
该字段的作用是在握手期间实现数据包合并（详见[第2.2章](#2.2_Coalesced_Packets)）。
 
令牌：

:  初始数据包可以包含一个令牌，它是一个客户端可选地发向服务器的可变长度不透明值，作用是验证客户端地址。
重试数据包也可以包含一个令牌，客户端可以在后续连接尝试的初始数据包中使用该令牌。
无论哪种情况，令牌的长度都是明确的。

重试数据包（详见《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第17.2.5章](../RFC9000_Chinese_Simplified/#17.2.5_Retry_Packet)）和版本协商数据包（详见《[QUIC传输](../RFC9000_Chinese_Simplified)》的[第17.2.1章](../RFC9000_Chinese_Simplified/#17.2.1_Version_Negotiation_Packet)）未受到加密保护。
重试数据包受到完整性保护。
重试数据包的内容是通过在后续的握手中使用传输参数的放肆来验证的。
对于其他类型的数据包，QUIC版本1在数据包头部中为其他信息提供加密保护：

数据包号：

:   除了版本协商数据包和重试数据包外的所有数据包都具有其关联的数据包号；不过，该数据包号受到加密，因此对路径上的观察者来说无法使用。
数据包号在长包头中的偏移位置可以被解码得到，而在短包头中则是隐式的（取决于目标连接ID的长度）。
数据包号的长度受到加密保护。

密钥阶段：

:   密钥阶段比特位（存在于短包头中）指定了用于加密数据包的密钥组，从而支持密钥轮换。
密钥阶段比特位受到加密保护。
